シェル芸で学ぶDevOps実践入門
===

## NTTソフトウェアイノベーションセンタ
## Hisaharu Ishii

---

# こんにちは
# こんにちは

----

## 今日はUSP友の会の方から来ました

----

## USP友の会とは

* Universal Shell Programming 友の会
* (たぶん)日本唯一のシェルプログラミングコミュニティ
* 最近は隔月で「シェル芸勉強会」を開催
* 公式サイト: https://www.usptomo.com/
* マスコットキャラクター「ちんじゅうちゃん」

![](https://blog.ueda.asia/wp-content/uploads/2014/12/CHINJYU.jpg)

----

## who am i

* Hisaharu Ishii (石井 久治) ![icon](https://pbs.twimg.com/profile_images/186175348/notepad.png)
* Twitter: @hisaharu
* 所属: NTT ソフトウェアイノベーションセンタ
* 今のおしごと: DevOps, Docker, 某山梨案件
* 昔のおしごと: SDN, OpenStack

---

## これからDevOpsの話をしよう

----

## ~~これからDevOpsの話をしよう~~
## もうアンカンで話したからいいよね？

----

## Dev: プログラマ の世界

* プログラムを書いて、要件を満たすソフトウェアを作ることが仕事
* (打合せ以外は)オフィスの自分の席で仕事
* 自分のPC 自分のキーボード 自分のエディタ
* 開発スケジュールに従って **遅れないように** 仕上げることが重要

----

## Ops: 運用担当≒インフラエンジニア の世界

* システムを **運用** して **止めない** ことが仕事
* 必要になればデータセンタにも行くし、床下に配線したりもする
* 寒いサーバルーム、小さい画面、固いキーボード
* vimが入ってない!!!
* トラブルが **起きたときに 呼び出される** (24時間365日)

----

## "DevOps" の問題提起

* Devはせっかく作ったコードを早く本番に出したい
* Opsは本番サイトがトラブルと仕事が増えるので、慎重に進めたい
* 結果として「作ったはいいが」「本番に出てない」状態が増える
* DevとOpsはそれぞれ自分たちの仕事をしているのに、なかなか"価値"につながらない

----

## 巷でよく言われる "DevOps"

* Devの世界では、生産性を上げるための手法やツールが近年著しく進化した
* Opsの世界にも、Devの手法やツールを "上手く" 使えば、スピードアップできるのではないか
* DevとOpsがチームとして分かれているのも原因だ。協力して動こう

---

## そうは言われても

----

## Opsのツラミ

* そうは言われても、相変わらずDevとはチームも役割も分かれている
* Devが使うような言語やツールを急に使えと言われても、勉強する暇もない

----

## いまOpsに必要なモノ

* 簡単な例から少しずつ始められて
* 日々の運用業務の中ですぐに使えて
* 幅広い用途に応用できる柔軟性や再利用性があって
* 流行り廃りに惑わされず継続的に安定して使えて
* 実際に運用業務の生産性が改善するような
* 手法やツール

---

## これから「シェル芸」の話をしよう

----

## 「シェル芸」とは

----

## シェル芸の定義

https://blog.ueda.asia/?page_id=1434

```
シェル芸の定義バージョン1.1

マウスも使わず、ソースコードも残さず、GUIツールを立ち上げる間もなく、
あらゆる調査・計算・テキスト処理をCLI端末へのコマンド入力一撃で終わらすこと。
あるいはそのときのコマンド入力のこと。
```

----

## 「シェル」とは

----

https://ja.wikipedia.org/wiki/シェル

```
シェル (shell) は
オペレーティングシステム (OS) のユーザーのために
インタフェースを提供するソフトウェアであり、
カーネルのサービスへのアクセスを提供する。
```

----

```
            +----------+ コマンド入力 +-------------+
            |          |<-------------| ユーザ端末  |
            |  シェル  |   結果出力   | (モニタ ＋  |
            |          |------------->|  キーボード)|
            +----------+              +-------------+
ユーザ空間      A  |                                 
--------------- |  | --------------                  
カーネル空間    |  V システムコール                  
            +----------+                             
            | カーネル |                             
            +----------+                             
```

* シェルは、ユーザとカーネルの間のインタフェースとなるソフトウェア
  * (実は、Windowsエクスプローラもシェルの一種)
* シェル芸では、Unix系OSのテキストベース(CUI)シェルを主に扱う

----

## シェルの動作モードには2種類ある

----

## インタラクティブモード

```
+----------+ コマンド入力 +-------------+
|          |<-------------| ユーザ端末  |
|  シェル  |   結果出力   | (モニタ ＋  |
|          |------------->|  キーボード)|
+----------+              +-------------+
```

* キー入力を読み込み、すぐにコマンドを実行して、結果を表示する

----

## シェルスクリプト

```
+----------+ 読み込み +----------+
|          |<---------| ファイル |
|          |          +----------+
|          |              +-------------+
|  シェル  |              | ユーザ端末  |
|          |   結果出力   | (モニタ ＋  |
|          |------------->|  キーボード)|
+----------+              +-------------+
```

* ファイルからコマンド列を一括して読み込み、逐次結果を表示する

----

```
+----------+ 読み込み +----------+
|          |<---------| ファイル |  <<-(これがシェルスクリプト)
|          |          +----------+
|          |              +-------------+
|  シェル  |              | ユーザ端末  |
|          |   結果出力   | (モニタ ＋  |
|          |------------->|  キーボード)|
+----------+              +-------------+
```

* シェルスクリプトは、スクリプト型(インタプリタ方式)のプログラミング言語

----

```
   (ここの入力は、                       
    シェルスクリプトと全く同じ文法)      
                   |                     
                   V                     
+----------+ コマンド入力 +-------------+
|          |<-------------| ユーザ端末  |
|  シェル  |   結果出力   | (モニタ ＋  |
|          |------------->|  キーボード)|
+----------+              +-------------+
```

* シェルスクリプトの文法は、インタラクティブモードでも全て使える

----

## つまり

----

```
シェル芸の定義バージョン1.1

マウスも使わず、ソースコードも残さず、GUIツールを立ち上げる間もなく、
あらゆる調査・計算・テキスト処理をCLI端末へのコマンド入力一撃で終わらすこと。
あるいはそのときのコマンド入力のこと。
```

* マウス: 使わない
* ソースコード(ファイル): 残さない
* GUIツール: 使わない

```
    (((全てをここに一撃で打ち込む)))     
                   |                     
                   V                     
+----------+ コマンド入力 +-------------+
|          |<-------------| ユーザ端末  |
|  シェル  |   結果出力   | (モニタ ＋  |
|          |------------->|  キーボード)|
+----------+              +-------------+
```

----

## シェルスクリプトと
## シェル芸は同じ？

----

# NO

----

* シェルスクリプト
  * 処理をファイルに書く
  * 何度も使える汎用的なプログラムを書く
  * 後から読みやすいコードを書く
* シェル芸
  * 端末に一撃で打ち込む
  * その瞬間のニーズを満たすことに集中する
  * 汎用性・可読性よりも一撃の早さを重視する

---

## 実際にやってみよう

----

### 問題:
### 2016年の日曜日を全て列挙してください。

　　　　　　　　　　出典: [第21回シェル芸勉強会 第3問](https://blog.ueda.asia/?p=7655)

----

## Excel職人:

* えーっと、まずDATE()関数で2016年1月1日と2016年12月31日のシリアル値を求めて...
* WEEKDAY()関数にシリアル値を渡せば曜日が分かるから...

----

## Python職人:

```
from datetime import date

d = date(2016,1,1)
while d < date(2017,1,1):
...
```

----

## シェル芸人

```
$ echo 2016{01..12}{01..31} | xargs -n1 | date -Rf- 2>/dev/null | grep Sun
```

----

## 分解してみる

----

## STEP1

```
$ echo 2016{01..12}{01..31}

20160101 20160102 20160103 20160104 20160105 20160106 20160107 20160108 2
0160109 20160110 20160111 20160112 20160113 20160114 20160115 20160116 20
160117 20160118 20160119 20160120 20160121 20160122 20160123 20160124 201
60125 20160126 20160127 20160128 20160129 20160130 20160131 20160201 2016
0202 20160203 20160204 20160205 20160206 20160207 20160208 20160209 20160
210 20160211 20160212 20160213 20160214 20160215 20160216 20160217 201602
18 20160219 20160220 20160221 20160222 20160223 20160224 20160225 2016022
6 20160227 20160228 20160229 20160230 20160231 20160301 20160302 20160303
...
```

----

## STEP2

```
$ echo 2016{01..12}{01..31} | xargs -n1

20160101
20160102
20160103
20160104
20160105
20160106
20160107
20160108
...
```

----

# STEP3

```
$ echo 2016{01..12}{01..31} | xargs -n1 | date -Rf- 2>/dev/null

Fri, 01 Jan 2016 00:00:00 +0900
Sat, 02 Jan 2016 00:00:00 +0900
Sun, 03 Jan 2016 00:00:00 +0900
Mon, 04 Jan 2016 00:00:00 +0900
Tue, 05 Jan 2016 00:00:00 +0900
Wed, 06 Jan 2016 00:00:00 +0900
Thu, 07 Jan 2016 00:00:00 +0900
Fri, 08 Jan 2016 00:00:00 +0900
...
```
----

# STEP4

```
$ echo 2016{01..12}{01..31} | xargs -n1 | date -Rf- 2>/dev/null | grep Sun

Sun, 03 Jan 2016 00:00:00 +0900
Sun, 10 Jan 2016 00:00:00 +0900
Sun, 17 Jan 2016 00:00:00 +0900
Sun, 24 Jan 2016 00:00:00 +0900
Sun, 31 Jan 2016 00:00:00 +0900
Sun, 07 Feb 2016 00:00:00 +0900
Sun, 14 Feb 2016 00:00:00 +0900
Sun, 21 Feb 2016 00:00:00 +0900
```

----

## つまり

```
echo 2016{01..12}{01..31} # 20160101 20160102 ... という数列を生成
                          # ただし、この時点では 20160231 など無効な日付を含む

xargs -n1                 # 数列を1行あたり1列になるように改行

date -Rf- 2>/dev/null     #標準入力から1行ずつ日付を読み込み(-fオプション)
                          #RFC822形式で出力(-Rオプション)
                          #無効な日付は標準エラーにメッセージが出力されるので
                          #/dev/nullデバイスにリダイレクトして黙殺

grep Sun                  #日曜日を表す行だけを抽出
```

---

## どうやって
## やってるの

----

## シェル芸の思想

* いま目の前で解きたい問題/課題に対し
* **UNIX哲学** に基づき
* Linux/Unixの標準コマンドの組み合わせによって
* 途中結果を実際に確かめながら
* ワンライナーで問題/課題を解決する

----

## UNIX哲学とは

1. 一つのことを行い、またそれをうまくやるプログラムを書け。
1. 協調して動くプログラムを書け。
1. 標準入出力（テキスト・ストリーム）を扱うプログラムを書け。標準入出力は普遍的インターフェースなのだ。

— ダグラス・マキルロイ、UNIXの四半世紀

---

## シェル芸に興味湧きました？

----

## ハンズオンやります

* いつ: このあと〜17:00まで
* どこで: 401ホールで
* 持ち物: ノートPC

----

## 題材

----

## Software Design 2017年1月号
* 特集 [新春bash書き初め] シェル30本ノック

![](http://image.gihyo.co.jp/assets/images/cover/2017/thumb/TH160_641701.jpg)

私も記事作成に協力しました(ステマ)

---

## ありがとうございました

