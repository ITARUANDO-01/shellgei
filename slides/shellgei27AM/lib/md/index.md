# シェル芸入門
# 日常会話編

USP友の会

Hisaharu Ishii

---

# こんにちは
# こんにちは

----

## Who am I

* Hisaharu Ishii (石井 久治)
* Twitter: @hisaharu ![icon](https://pbs.twimg.com/profile_images/186175348/notepad.png)
* おしごと: 通信会社の研究所
  * Docker, SDN, OpenStack...
* 趣味: シェル芸

----

## このスライドのねらい

* 初心者の方にシェル芸の始めかたを教えます
  * 玄人は布教方法の参考にして下さい
* 構成
  1. シェル芸とは何か
  2. シェル芸の考え方
  3. シェル芸の基礎文法
  4. シェル芸の頻出単語

---

## 1. シェル芸とは何か

----

## シェル芸の定義

https://blog.ueda.asia/?page_id=1434

```
シェル芸の定義バージョン1.1

マウスも使わず、ソースコードも残さず、GUIツールを立ち上げる間もなく、
あらゆる調査・計算・テキスト処理をCLI端末へのコマンド入力一撃で終わらすこと。
あるいはそのときのコマンド入力のこと。
```

----

## 「シェル」とは

----

https://ja.wikipedia.org/wiki/シェル

```
シェル (shell) は
オペレーティングシステム (OS) のユーザーのために
インタフェースを提供するソフトウェアであり、
カーネルのサービスへのアクセスを提供する。
```

----

```
            +----------+ コマンド入力 +-------------+
            |          |<-------------| ユーザ端末  |
            |  シェル  |   結果出力   | (モニタ ＋  |
            |          |------------->|  キーボード)|
            +----------+              +-------------+
ユーザ空間      A  |                                 
--------------- |  | --------------                  
カーネル空間    |  V システムコール                  
            +----------+                             
            | カーネル |                             
            +----------+                             
```

* シェルは、ユーザとカーネルの間のインタフェースとなるソフトウェア
  * (実は、Windowsエクスプローラもシェルの一種)
* シェル芸では、Unix系OSのテキストベース(CUI)シェルを主に扱う

----

```
シェル芸の定義バージョン1.1

マウスも使わず、ソースコードも残さず、GUIツールを立ち上げる間もなく、
あらゆる調査・計算・テキスト処理をCLI端末へのコマンド入力一撃で終わらすこと。
あるいはそのときのコマンド入力のこと。
```

* マウス: 使わない
* ソースコード(ファイル): 残さない
* GUIツール: 使わない

```
    (((全てをここに一撃で打ち込む)))     
                   |                     
                   V                     
+----------+ コマンド入力 +-------------+
|          |<-------------| ユーザ端末  |
|  シェル  |   結果出力   | (モニタ ＋  |
|          |------------->|  キーボード)|
+----------+              +-------------+
```

---

## 例題

----

### 問題:
### 2016年の日曜日を全て列挙してください。

　　　　　　　　　　出典: [第21回シェル芸勉強会 第3問](https://blog.ueda.asia/?p=7655)

----

## Excel職人:

* えーっと、まずDATE()関数で2016年1月1日と2016年12月31日のシリアル値を求めて...
* WEEKDAY()関数にシリアル値を渡せば曜日が分かるから...

----

## Python職人:

```
from datetime import date

d = date(2016,1,1)
while d < date(2017,1,1):
...
```

----

## シェル芸人

```
$ echo 2016{01..12}{01..31} | xargs -n1 | date -Rf- 2>/dev/null | grep Sun
```

----

## 分解してみる

----

## STEP1

```
$ echo 2016{01..12}{01..31}

20160101 20160102 20160103 20160104 20160105 20160106 20160107 20160108 2
0160109 20160110 20160111 20160112 20160113 20160114 20160115 20160116 20
160117 20160118 20160119 20160120 20160121 20160122 20160123 20160124 201
60125 20160126 20160127 20160128 20160129 20160130 20160131 20160201 2016
0202 20160203 20160204 20160205 20160206 20160207 20160208 20160209 20160
210 20160211 20160212 20160213 20160214 20160215 20160216 20160217 201602
18 20160219 20160220 20160221 20160222 20160223 20160224 20160225 2016022
6 20160227 20160228 20160229 20160230 20160231 20160301 20160302 20160303
...
```

----

## STEP2

```
$ echo 2016{01..12}{01..31} | xargs -n1

20160101
20160102
20160103
20160104
20160105
20160106
20160107
20160108
...
```

----

## STEP3

```
$ echo 2016{01..12}{01..31} | xargs -n1 | date -Rf- 2>/dev/null

Fri, 01 Jan 2016 00:00:00 +0900
Sat, 02 Jan 2016 00:00:00 +0900
Sun, 03 Jan 2016 00:00:00 +0900
Mon, 04 Jan 2016 00:00:00 +0900
Tue, 05 Jan 2016 00:00:00 +0900
Wed, 06 Jan 2016 00:00:00 +0900
Thu, 07 Jan 2016 00:00:00 +0900
Fri, 08 Jan 2016 00:00:00 +0900
...
```
----

## STEP4

```
$ echo 2016{01..12}{01..31} | xargs -n1 | date -Rf- 2>/dev/null | grep Sun

Sun, 03 Jan 2016 00:00:00 +0900
Sun, 10 Jan 2016 00:00:00 +0900
Sun, 17 Jan 2016 00:00:00 +0900
Sun, 24 Jan 2016 00:00:00 +0900
Sun, 31 Jan 2016 00:00:00 +0900
Sun, 07 Feb 2016 00:00:00 +0900
Sun, 14 Feb 2016 00:00:00 +0900
Sun, 21 Feb 2016 00:00:00 +0900
```

----

## つまり

```
echo 2016{01..12}{01..31} # 20160101 20160102 ... という数列を生成
                          # ただし、この時点では 20160231 など無効な日付を含む

xargs -n1                 # 数列を1行あたり1列になるように改行

date -Rf- 2>/dev/null     #標準入力から1行ずつ日付を読み込み(-fオプション)
                          #RFC822形式で出力(-Rオプション)
                          #無効な日付は標準エラーにメッセージが出力されるので
                          #/dev/nullデバイスにリダイレクトして黙殺

grep Sun                  #日曜日を表す行だけを抽出
```

---

## 2. シェル芸の考え方

----

## シェル芸の思想

* いま目の前で解きたい問題/課題に対し
* **UNIX哲学** に基づき
* Linux/Unixの標準コマンドの組み合わせによって
* 途中結果を実際に確かめながら
* ワンライナーで問題/課題を解決する

----

## UNIX哲学

1. 一つのことを行い、またそれをうまくやるプログラムを書け。
1. 協調して動くプログラムを書け。
1. 標準入出力（テキスト・ストリーム）を扱うプログラムを書け。標準入出力は普遍的インターフェースなのだ。

— ダグラス・マキルロイ、UNIXの四半世紀

----

## シェルとコマンド

シェルはユーザ端末から受け付けた「コマンドライン」を解釈し、システムコールを呼び出してコマンドを実行する

```
+----------+ /bin/echo hoge +-------------+
|  シェル  |<---------------| ユーザ端末  |
+----------+                |             |
  | exec(/bin/echo, hoge)   |             |
  |  +-----------+          |             |
  |  | /bin/echo |--------->|             |
  |  +-----------+    hoge  +-------------+
  |   A  hoge                              
- | - | -----------------------------------
  V   |                                    
+----------+                               
| カーネル |                               
+----------+                               
```
コマンドライン「/bin/echo hoge」を実行した時の例

----

## 標準入出力

* それぞれのコマンドが実行される際に
  * データの入力で「標準的に」使われるのが標準入力(stdin)
  * データの出力で「標準的に」使われるのが標準出力(stdout)

```
     +-----------------+              +-------------+
     |         標準入力=<-------------| ユーザ端末  |
     |コマンド         |              | (モニタ ＋  |
     |         標準出力=------------->|  キーボード)|
     +-----------------+              +-------------+
```

----

## リダイレクト

標準入力や標準出力をつなぐ先は、ユーザ端末だけでなく、ファイルに付け替えることができる

```
     +-----------------+              +-------------+
     |         標準入力=<---[fileA]   | ユーザ端末  |
     |command1         |              | (モニタ ＋  |
     |         標準出力=------------->|  キーボード)|
     +-----------------+              +-------------+
```
`command1 < fileA`

```
     +-----------------+              +-------------+
     |         標準入力=<-------------| ユーザ端末  |
     |command1         |              | (モニタ ＋  |
     |         標準出力=--->[fileB]   |  キーボード)|
     +-----------------+              +-------------+
```
`command1 > fileB`

----

## パイプ

あるコマンドの標準出力を、別のコマンドの標準入力につなぐことができる

```
     +-----------------+              +-------------+
     |         標準入力=<-------------| ユーザ端末  |
     |command1         |              | (モニタ ＋  |
     |         標準出力|              |  キーボード)|
     +----------- | ---+              |             |
                  |                   |             |
               (パイプ)               |             |
                  |                   |             |
     +----------- V ---+              |             |
     |         標準入力|              |             |
     |command2         |              |             |
     |         標準出力=------------->|             |
     +-----------------+              +-------------+
```

`command1 | command2`

----

## フィルタ

* 自分自身では直接ファイルを読み書きせず
* 標準入力から読み込んで
* 標準出力に書き込む
* ようなコマンドをフィルタと呼ぶ

```
                  |     
     +----------- V ---+
     |         標準入力|
     |フィルタ         |
     |         標準出力|
     +----------- | ---+
                  V     
```

---

## 3. シェル芸の基礎文法

----

## シェル(Bash)で使える要素

* シェル自体の機能
  * 組込みコマンド
  * コマンドの複合
  * 制御構造
  * 変数
  * 展開
* 外部コマンド

----

## コマンドの複合

| 機能 | 文法 |
| ---- | ---- |
| パイプ | command1 &brvbar; command2 |
| リダイレクト | `>file`　`>>file`　`<file`　|

----

## 制御構造

* `if ... ; then ... ; elif ... ; fi`
* `for ... ; do ... ; done`
* `while ... ; do ... ; done`

----

## 展開

| 種類 | 文法 |
| ---- | ---- |
| パラメータ展開 | `${hoge}` |
| コマンド置換 | `$(command)` |
| パス名展開 | `*.file` |
| ブレース展開 | `{foo,bar}` `{1..10}` |
| プロセス置換 | `<(command)` `>(command)` |

---

## 4. シェル芸の頻出単語
## (組み込みコマンド/外部コマンド)

----

## 外部コマンド(ディレクトリ操作系)

| コマンド | 機能 |
| -------- | ---- |
| cd | カレントディレクトリ移動 |
| pwd | カレントディレクトリ表示 |
| ls | ファイル一覧表示 |
| find | ファイル検索 |
| mkdir | ディレクトリ作成 |
| rmdir | ディレクトリ削除 |

----

## 外部コマンド(ファイル操作系)

| コマンド | 機能 |
| -------- | ---- |
| mv | 移動 |
| cp | コピー |
| rm | 削除 |
| cat | ファイル内容出力 |
| touch | 空ファイル作成・更新日時変更 |

----

## 外部コマンド(フィルタ系)

| コマンド | 機能 |
| -------- | ---- |
| head | 先頭行 |
| tail | 末尾行 |
| cut | 列選択 |
| tac | 行単位の反転 |
| tee | ファイルと標準出力に分岐 |

----

## 外部コマンド(テキスト処理系)

| コマンド | 機能 |
| -------- | ---- |
| sort | ソート |
| uniq | 重複除去 |
| wc | 文字数カウント |
| nl | 行数表示 |
| grep | 正規表現で検索 |
| diff | 比較 |
| tr | 文字置換 |

----

## 外部コマンド(スクリプト・その他系)

| コマンド | 機能 |
| -------- | ---- |
| sed | ストリームエディタ |
| awk | パターン検索・処理言語 |
| xargs | 標準入力をコマンド引数に変換 |
| date | 日付 |
| yes | 無限出力 |
| seq | 連番 |
| shuf | ランダムシャッフル |
| factor | 素因数分解 |

----

## 組込みコマンド

| コマンド | 機能 |
| -------- | ---- |
| echo | コマンド引数を標準出力へ |
| printf | 文字列整形 |
| read | 標準入力を変数へ |
| eval | 黒魔術 |

---

## オススメの参考書

----

## [新しいLinuxの教科書](https://www.amazon.co.jp/dp/4797380942)

![](https://images-na.ssl-images-amazon.com/images/I/51GjYXdAPBL.jpg)

----

## [シェルスクリプト基本リファレンス](https://www.amazon.co.jp/dp/4774146439)

![](https://images-na.ssl-images-amazon.com/images/I/41GMyWgQ3cL.jpg)

----

## [シェルプログラミング実用テクニック](https://www.amazon.co.jp/dp/4774173444)

![](https://images-na.ssl-images-amazon.com/images/I/71FHRDG75tL.jpg)

----

## [Software Design 2017年1月号](http://gihyo.jp/magazine/SD/archive/2017/201701)
* 特集 [新春bash書き初め] シェル30本ノック

![](http://image.gihyo.co.jp/assets/images/cover/2017/thumb/TH160_641701.jpg)

---

## ありがとうございました

