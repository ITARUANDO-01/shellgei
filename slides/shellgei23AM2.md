# シェル芸入門

USP友の会

Hisaharu Ishii

---

## Who am I

* Hisaharu Ishii (石井 久治)
* Twitter: @hisaharu ![icon](https://pbs.twimg.com/profile_images/186175348/notepad.png)
* おしごと: 通信会社の研究所
  * Docker, SDN, OpenStack...
* 趣味: シェル芸

---

## これから「シェル芸」の話をしよう

___

## 「シェル芸」とは

___

## シェル芸の定義

https://blog.ueda.asia/?page_id=1434

```
シェル芸の定義バージョン1.1

マウスも使わず、ソースコードも残さず、GUIツールを立ち上げる間もなく、
あらゆる調査・計算・テキスト処理をCLI端末へのコマンド入力一撃で終わらすこと。
あるいはそのときのコマンド入力のこと。
```

___

## 「シェル」とは

___

https://ja.wikipedia.org/wiki/シェル

```
シェル (shell) は
オペレーティングシステム (OS) のユーザーのために
インタフェースを提供するソフトウェアであり、
カーネルのサービスへのアクセスを提供する。
```

___

## 「芸」とは

___

https://ja.wikipedia.org/wiki/芸能

```
芸能（げいのう）とは、
芸術の諸ジャンルのうち、
人間の身体をもって表現する技法のことである。
```
___

## ＿人人人人人人人人人＿
## ＞　シェル芸は芸術　＜
## ￣Y^Y^Y^Y^Y^Y^Y^Y^Y^￣

---

## 芸術を教えるのは難しい・・・

___

## ならば、少し見方を変えて
## 仮説：
## シェル芸はプログラミングの一種

___

## どういうことか

___

## 再掲：「シェル」とは

https://ja.wikipedia.org/wiki/シェル

```
シェル (shell) は
オペレーティングシステム (OS) のユーザーのために
インタフェースを提供するソフトウェアであり、
カーネルのサービスへのアクセスを提供する。
```

___

```
            +----------+ コマンド入力 +-------------+
            |          |<-------------| ユーザ端末  |
            |  シェル  |   結果出力   | (モニタ ＋  |
            |          |------------->|  キーボード)|
            +----------+              +-------------+
ユーザ空間      A  |                                 
--------------- |  | --------------                  
カーネル空間    |  V システムコール                  
            +----------+                             
            | カーネル |                             
            +----------+                             
```

* シェルは、ユーザとカーネルの間のインタフェースとなるソフトウェア
  * (実は、Windowsエクスプローラもシェルの一種)
* シェル芸では、Unix系OSのテキストベース(CUI)シェルを主に扱う

___

## シェルの動作モードには2種類ある

___

## インタラクティブモード

```
+----------+ コマンド入力 +-------------+
|          |<-------------| ユーザ端末  |
|  シェル  |   結果出力   | (モニタ ＋  |
|          |------------->|  キーボード)|
+----------+              +-------------+
```

* キー入力を読み込み、すぐにコマンドを実行して、結果を表示する

___

## シェルスクリプト

```
+----------+ 読み込み +----------+
|          |<---------| ファイル |
|          |          +----------+
|          |              +-------------+
|  シェル  |              | ユーザ端末  |
|          |   結果出力   | (モニタ ＋  |
|          |------------->|  キーボード)|
+----------+              +-------------+
```

* ファイルからコマンド列を一括して読み込み、逐次結果を表示する

___

```
+----------+ 読み込み +----------+
|          |<---------| ファイル |  <<-(これがシェルスクリプト)
|          |          +----------+
|          |              +-------------+
|  シェル  |              | ユーザ端末  |
|          |   結果出力   | (モニタ ＋  |
|          |------------->|  キーボード)|
+----------+              +-------------+
```

* シェルスクリプトは、スクリプト型(インタプリタ方式)のプログラミング言語

___

```
   (ここの入力は、                       
    シェルスクリプトと全く同じ文法)      
                   |                     
                   V                     
+----------+ コマンド入力 +-------------+
|          |<-------------| ユーザ端末  |
|  シェル  |   結果出力   | (モニタ ＋  |
|          |------------->|  キーボード)|
+----------+              +-------------+
```

* シェルスクリプトの文法は、インタラクティブモードでも全て使える

___

## つまり

___

```
シェル芸の定義バージョン1.1

マウスも使わず、ソースコードも残さず、GUIツールを立ち上げる間もなく、
あらゆる調査・計算・テキスト処理をCLI端末へのコマンド入力一撃で終わらすこと。
あるいはそのときのコマンド入力のこと。
```

* マウス: 使わない
* ソースコード(ファイル): 残さない
* GUIツール: 使わない

```
    (((全てをここに一撃で打ち込む)))     
                   |                     
                   V                     
+----------+ コマンド入力 +-------------+
|          |<-------------| ユーザ端末  |
|  シェル  |   結果出力   | (モニタ ＋  |
|          |------------->|  キーボード)|
+----------+              +-------------+
```

___

```
    (((全てをここに一撃で打ち込む)))     
                   |                     
                   V                     
+----------+ コマンド入力 +-------------+
|          |<-------------| ユーザ端末  |
|  シェル  |   結果出力   | (モニタ ＋  |
|          |------------->|  キーボード)|
+----------+              +-------------+
```

* ソースコードをファイルに書き出さないだけで、打ち込んでいるコマンドは、インタプリタ型のプログラムそのもの

___

## ＿人人人人人人人人人＿
## ＞　　シェル芸は　　＜
## ＞　プログラミング　＜
## ￣Y^Y^Y^Y^Y^Y^Y^Y^Y^￣

---

## それなら
## シェルスクリプトと
## シェル芸は同じ？

___

# NO

___

* シェルスクリプト
  * 処理をファイルに書く
  * 何度も使える汎用的なプログラムを書く
  * 後から読みやすいコードを書く
* シェル芸
  * 端末に一撃で打ち込む
  * その瞬間のニーズを満たすことに集中する
  * 汎用性・可読性よりも一撃の早さを重視する

___

## ＿人人人人人人人＿
## ＞　シェル芸は　＜
## ＞　一撃必中　　＜
## ￣Y^Y^Y^Y^Y^Y^Y^￣

---

## どうすれば
## 素早い一撃を繰り出せるか？

___

## 持ち技の多さが一撃の幅を広げる

___

## シェル(Bash)で使える要素

* シェル自体の機能
  * 組込みコマンド
  * コマンドの複合
  * 制御構造
  * 変数
  * 展開
* 外部コマンド

___

## 全部を一度に覚えるのは無理
## 　
## シェル芸勉強会に参加して
## 知らない機能が出てきたら
## 何か1つを身に付けて帰る

___

## シェル芸
## 頻出単語30
## (適当)

___

## 外部コマンド(ファイル操作系)

* ls ファイル名リスト
* mv 移動
* cp コピー
* rm 削除
* cat ファイル内容出力
* mkdir ディレクトリ作成
* rmdir ディレクトリ削除
* find ファイル名検索
* touch 空ファイル作成・更新日時変更

___

## 外部コマンド(テキスト処理系)

* wc 文字数カウント
* nl 行数表示
* sort ソート
* uniq 重複除去
* cut 列選択
* tr 文字置換
* head 先頭行
* tail 末尾行
* tac 行単位の反転
* diff 比較
* grep 正規表現で検索
* tee ファイルと標準出力に分岐

___

## 外部コマンド(スクリプト・その他系)

* sed ストリームエディタ
* awk パターン検索・処理言語

* xargs 標準入力をコマンド引数に変換
* date 日付
* yes 無限出力
* seq 連番
* shuf ランダムシャッフル
* factor 素因数分解

___

## 組込みコマンド

* echo コマンド引数を標準出力へ
* printf 文字列整形
* read 標準入力を変数へ
* eval 黒魔術

___

## コマンドの複合

* `|` パイプ
* `>file`　`>>file`　`<file`　リダイレクト

___

## 制御構造

* `if ... ; then ... ; elif ... ; fi`
* `for ... ; do ... ; done`
* `while ... ; do ... ; done`

___

## 展開

* `${hoge}` パラメータ展開
* `$(command)` コマンド置換
* `*.file` パス名展開
* `{foo,bar}` `{1..10}` ブレース展開
* `<(command)` `>(command)` プロセス置換

___

## (大事なことなので再掲)
## 全部を一度に覚えるのは無理
## 　
## シェル芸勉強会に参加して
## 知らない機能が出てきたら
## 何か1つを身に付けて帰る

---

## なんでコマンドがこんなにあるの？

___

## UNIX哲学

```
一つのことを行い、またそれをうまくやるプログラムを書け。
協調して動くプログラムを書け。
標準入出力（テキスト・ストリーム）を扱うプログラムを書け。
標準入出力は普遍的インターフェースなのだ。

これがUNIXの哲学である。
```

https://ja.wikipedia.org/wiki/UNIX哲学

---

## たとえば

### 問題:
### 2016年の日曜日を全て列挙してください。

　　　　　　　　　　出典: [第21回シェル芸勉強会 第3問](https://blog.ueda.asia/?p=7655)

___

## Excel職人:

* えーっと、まずDATE()関数で2016年1月1日と2016年12月31日のシリアル値を求めて...
* WEEKDAY()関数にシリアル値を渡せば曜日が分かるから...

___

## Python職人:

```
from datetime import date

d = date(2016,1,1)
while d < date(2017,1,1):
...
```

___

## シェル芸人

```
$ echo 2016{01..12}{01..31} | xargs -n1 | date -Rf- 2>/dev/null | grep Sun
```

___

## 分解してみる

___

## STEP1

```
$ echo 2016{01..12}{01..31}

20160101 20160102 20160103 20160104 20160105 20160106 20160107 20160108 2
0160109 20160110 20160111 20160112 20160113 20160114 20160115 20160116 20
160117 20160118 20160119 20160120 20160121 20160122 20160123 20160124 201
60125 20160126 20160127 20160128 20160129 20160130 20160131 20160201 2016
0202 20160203 20160204 20160205 20160206 20160207 20160208 20160209 20160
210 20160211 20160212 20160213 20160214 20160215 20160216 20160217 201602
18 20160219 20160220 20160221 20160222 20160223 20160224 20160225 2016022
6 20160227 20160228 20160229 20160230 20160231 20160301 20160302 20160303
...
```

___

## STEP2

```
$ echo 2016{01..12}{01..31} | xargs -n1

20160101
20160102
20160103
20160104
20160105
20160106
20160107
20160108
...
```

___

# STEP3

```
$ echo 2016{01..12}{01..31} | xargs -n1 | date -Rf- 2>/dev/null

Fri, 01 Jan 2016 00:00:00 +0900
Sat, 02 Jan 2016 00:00:00 +0900
Sun, 03 Jan 2016 00:00:00 +0900
Mon, 04 Jan 2016 00:00:00 +0900
Tue, 05 Jan 2016 00:00:00 +0900
Wed, 06 Jan 2016 00:00:00 +0900
Thu, 07 Jan 2016 00:00:00 +0900
Fri, 08 Jan 2016 00:00:00 +0900
...
```
___

# STEP4

```
$ echo 2016{01..12}{01..31} | xargs -n1 | date -Rf- 2>/dev/null | grep Sun

Sun, 03 Jan 2016 00:00:00 +0900
Sun, 10 Jan 2016 00:00:00 +0900
Sun, 17 Jan 2016 00:00:00 +0900
Sun, 24 Jan 2016 00:00:00 +0900
Sun, 31 Jan 2016 00:00:00 +0900
Sun, 07 Feb 2016 00:00:00 +0900
Sun, 14 Feb 2016 00:00:00 +0900
Sun, 21 Feb 2016 00:00:00 +0900
```

___

## つまり

```
echo 2016{01..12}{01..31} # 20160101 20160102 ... という数列を生成
                          # ただし、この時点では 20160231 など無効な日付を含む

xargs -n1                 # 数列を1行あたり1列になるように改行

date -Rf- 2>/dev/null     #標準入力から1行ずつ日付を読み込み(-fオプション)
                          #RFC822形式で出力(-Rオプション)
                          #無効な日付は標準エラーにメッセージが出力されるので
                          #/dev/nullデバイスにリダイレクトして黙殺

grep Sun                  #日曜日を表す行だけを抽出
```

---

## まとめ

* シェル芸は芸術
* シェル芸はプログラミング
* 勉強会に出て機能を1つ覚えて帰ろう

---

## オススメの参考書

___

## [新しいLinuxの教科書](https://www.amazon.co.jp/dp/4797380942)

![](https://images-na.ssl-images-amazon.com/images/I/51GjYXdAPBL.jpg)

___

## [シェルスクリプト基本リファレンス](https://www.amazon.co.jp/dp/4774146439)

![](https://images-na.ssl-images-amazon.com/images/I/41GMyWgQ3cL.jpg)

___

## [シェルプログラミング実用テクニック](https://www.amazon.co.jp/dp/4774173444)

![](https://images-na.ssl-images-amazon.com/images/I/71FHRDG75tL.jpg)

---

## 参考資料

* [このスライド](http://slideck.io/github.com/hisaharu/shellgei/slides/shellgei23AM2.md)
* [このスライドのソース](https://github.com/hisaharu/shellgei/blob/master/slides/shellgei23AM2.md)
* [Slideck](https://slideck.io/)

* [シェル芸勉強会の過去問](https://blog.ueda.asia/?page_id=684)

* [シェル芸練習用Dockerイメージ](https://hub.docker.com/r/hisaharu/shellgei)
* [Dockerfile](https://github.com/hisaharu/shellgei/blob/master/Dockerfile)

